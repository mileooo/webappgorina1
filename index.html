<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–§–µ—Ä–º–∞Fresh ‚Äî —Å–≤–µ–∂–∏–µ –æ–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --white:#FFFFFF;
  --card-bg:#FAF9F6;
  --brand:#A4DE02;
  --cta:#FF8C42;
  --text:#2E2E2E;
  --muted:#666666;
  --border:#E6E6E6;
  --success:#5CB85C;
  --danger:#E74C3C;
  --shadow: 0 2px 8px rgba(0,0,0,0.05);
  --container:1200px;
}

/* –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--white);color:var(--text);font-family:Inter,Arial,sans-serif;-webkit-font-smoothing:antialiased}
a{color:inherit;text-decoration:none}
button,input,select,textarea{font-family:inherit}

/* layout */
.container{max-width:var(--container);margin:0 auto;padding:24px;}
.header{position:sticky;top:0;z-index:60;background:rgba(255,255,255,0.98);backdrop-filter:blur(4px);border-bottom:1px solid var(--border)}
.header-inner{max-width:var(--container);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:12px 24px;gap:20px}
.logo{display:flex;align-items:center;gap:12px}
.logo .mark{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--brand),#7cc900);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(164,222,2,0.12)}
.logo .mark svg{width:22px;height:22px;fill:#fff}
.logo h4{font-family:Poppins,Inter;font-weight:700;font-size:18px;margin:0;color:var(--text)}
.header-right{display:flex;align-items:center;gap:12px}

/* –º–µ–ª–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã —à–∞–ø–∫–∏ */
.search-wrap{display:flex;align-items:center;gap:8px;background:#fff;padding:6px;border-radius:12px;border:1px solid var(--border)}
.search-wrap input{border:0;outline:0;padding:8px 10px;width:320px;border-radius:8px}
.sort-select{padding:8px;border-radius:8px;border:1px solid var(--border);background:#fff}
.loyalty-badge{background:linear-gradient(180deg,#fff,#f4fff0);padding:8px 12px;border-radius:999px;border:1px solid rgba(164,222,2,0.12);font-weight:700;color:#2e2e2e}

/* hero */
.hero{max-width:var(--container);margin:20px auto;padding:20px;background:var(--card-bg);border-radius:12px;display:flex;gap:16px;align-items:center;box-shadow:var(--shadow)}
.hero-left{flex:1;min-width:220px}
.hero h1{font-family:Poppins;font-weight:800;font-size:32px;margin:0 0 6px;color:var(--text);line-height:1.02}
.hero p{font-size:15px;color:var(--muted);margin:0 0 8px}
.hero-cta{display:flex;gap:10px}
.btn-cta{background:var(--cta);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;font-family:Poppins;box-shadow:0 6px 18px rgba(255,140,66,0.12);transition:transform .14s}
.btn-secondary{background:transparent;border:1px solid var(--border);padding:8px 12px;border-radius:10px;color:var(--text);cursor:pointer}

/* grid & cards */
.main{max-width:var(--container);margin:0 auto;padding:8px 24px 140px}
.controls{display:flex;gap:12px;align-items:center;margin:10px 0;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px}
.card{background:var(--card-bg);border-radius:10px;box-shadow:var(--shadow);padding:10px;display:flex;flex-direction:column;gap:8px;min-height:330px;transition:transform .18s,box-shadow .18s;position:relative;overflow:hidden}
.card:hover{transform:translateY(-6px);box-shadow:0 10px 28px rgba(0,0,0,0.08)}
.photo{height:62%;border-radius:8px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center}
.photo img{width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .35s;border-radius:6px}
.info{display:flex;flex-direction:column;gap:6px;flex:1}
.name{font-family:Poppins;font-weight:600;font-size:15px;color:var(--text)}
.desc{font-size:13px;color:var(--muted);min-height:34px}
.price{font-weight:800;color:var(--text);font-size:16px}
.actions{display:flex;align-items:center;gap:8px;justify-content:space-between}
.qty-input{width:78px;padding:8px;border-radius:8px;border:1px solid var(--border);text-align:center}
.unit-select{padding:8px;border-radius:8px;border:1px solid var(--border);background:#fff}
.add-to-cart{background:var(--brand);color:#fff;border:0;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer;box-shadow:0 6px 12px rgba(164,222,2,0.12);transition:background .12s}
.add-to-cart:hover{background:var(--cta)}
.reco{margin-top:6px;font-size:13px;color:var(--muted)}
.custom-btn{background:#fff;border:1px solid var(--border);padding:8px;border-radius:8px;cursor:pointer}

/* floating cart widget (–≤–Ω–∏–∑—É) */
.floating-cart {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background-color: var(--brand);
  color: #fff;
  padding: 12px 16px;
  border-radius: 999px;
  box-shadow: 0 8px 26px rgba(0,0,0,0.18);
  cursor: pointer;
  font-weight:700;
  z-index: 1000;
  display:flex;
  align-items:center;
  gap:10px;
  min-width:180px;
  justify-content:center;
  transition:transform .14s;
}
.floating-cart:hover{ transform:scale(1.03); }
.floating-cart .fc-info{display:flex;flex-direction:column;align-items:flex-start;line-height:1}
.floating-cart .fc-count{font-size:14px}
.floating-cart .fc-total{font-size:14px;font-weight:800}

/* cart panel (–Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å) */
.cart-panel{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  margin:0 auto;
  max-width:420px;
  width:calc(100% - 36px);
  background:var(--white);
  border-top-left-radius:16px;
  border-top-right-radius:16px;
  box-shadow:0 -12px 36px rgba(0,0,0,0.18);
  padding:14px;
  z-index:999;
  border:1px solid var(--border);
  transform: translateY(110%);
  transition: transform 0.32s cubic-bezier(.2,.9,.2,1);
}
.cart-panel.show {
  transform: translateY(0);
}
.cart-panel h4{margin:0 0 10px;font-family:Poppins}
.cart-items{max-height:54vh;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:8px}
.cart-row{display:flex;align-items:center;justify-content:space-between;background:#fbfbfb;padding:10px;border-radius:8px;border:1px solid var(--border)}
.cart-row .left{display:flex;flex-direction:column}
.cart-total{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-weight:800;font-size:16px}
.cart-actions{display:flex;gap:8px;margin-top:12px}
.btn{padding:10px;border-radius:12px;border:0;cursor:pointer;font-weight:700}
.btn-clear{background:#f2f2f2;color:var(--text)}
.btn-check{background:var(--brand);color:#fff}
.btn-check:hover{background:var(--cta)}

/* modal */
.modal { position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:90; }
.modal .panel { width:920px;max-width:95%;background:var(--card-bg);border-radius:12px;padding:18px;box-shadow:0 12px 36px rgba(0,0,0,0.18); }
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-row{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
.form-row label{font-weight:600;font-size:14px}
.form-row input, .form-row select, .form-row textarea {padding:10px;border-radius:8px;border:1px solid #ccc}
.form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

/* responsive */
@media (max-width:980px){
  .grid{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
  .cart-panel{right:12px;left:12px;width:calc(100% - 24px);max-width:100%;bottom:0}
  .modal .panel{width:95%}
}
.footer{max-width:var(--container);margin:40px auto 80px;padding:24px;text-align:center;color:var(--muted);font-size:14px}
.fade-in{animation:fadeIn .35s ease both}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.small{font-size:13px;color:var(--muted)}

/* tiny checkmark animation */
.checkmark{position:absolute;right:12px;top:12px;background:var(--success);color:#fff;padding:6px;border-radius:8px;opacity:0;transform:scale(.6);transition:all .4s}
</style>
</head>
<body>
<header class="header">
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="logo">
        <div class="mark" aria-hidden>
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8 6 4 6 2 8c2 2 2 6 6 10s8 6 10 6c-2-6 0-12-6-22z"/></svg>
        </div>
        <h4>–§–µ—Ä–º–∞Fresh</h4>
      </div>
      <div style="margin-left:14px" class="small">–°–≤–µ–∂–µ—Å—Ç—å, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å</div>
    </div>

    <div class="header-right">
      <div class="search-wrap" title="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º">
        <input id="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–Ω–∞–Ω, –ü–æ–º–∏–¥–æ—Ä—ã)"/>
        <select id="sort-select" class="sort-select" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞">
          <option value="default">–°–æ—Ä—Ç</option>
          <option value="price_asc">–¶–µ–Ω–∞ ‚Üë</option>
          <option value="price_desc">–¶–µ–Ω–∞ ‚Üì</option>
          <option value="name_asc">A ‚Üí –Ø</option>
          <option value="name_desc">–Ø ‚Üí A</option>
        </select>
      </div>

      <div class="loyalty-badge" id="loyalty-badge" title="–í–∞—à–∏ –±–∞–ª–ª—ã">–ë–∞–ª–ª—ã: 0</div>
      <!-- –í–µ—Ä—Ö–Ω—è—è –∏–∫–æ–Ω–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã —É–±—Ä–∞–Ω–∞ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ –ø–ª–∞–≤–∞—é—â–∏–π –≤–∏–¥–∂–µ—Ç –≤–Ω–∏–∑—É) -->
    </div>
  </div>
</header>

<section class="hero container">
  <div class="hero-left">
    <h1>–°–≤–µ–∂–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã ‚Äî –ø—Ä—è–º–æ –∫ –≤–∞–º –¥–æ–º–æ–π</h1>
    <p>–î–æ—Å—Ç–∞–≤–∏–º –∑–∞ 60 –º–∏–Ω—É—Ç –∏–∑ —Ñ–µ—Ä–º–µ—Ä—Å–∫–∏—Ö —Ö–æ–∑—è–π—Å—Ç–≤. –í—ã–±–µ—Ä–∏ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞.</p>
    <div class="hero-cta">
      <button class="btn-cta" id="hero-order">–ó–∞–∫–∞–∑–∞—Ç—å —Å–µ–π—á–∞—Å</button>
      <button class="btn-secondary" id="view-catalog">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞—Ç–∞–ª–æ–≥</button>
    </div>
  </div>
  <div class="hero-right" style="min-width:260px">
    <div class="hero-image" style="height:160px;border-radius:10px">
      <img src="https://images.unsplash.com/photo-1518976024611-6d9b0b0b1f7f?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=0a9c9e3b9a95f1b8ad1b" alt="–°–≤–µ–∂–∏–µ —Ñ—Ä—É–∫—Ç—ã" style="width:100%;height:100%;object-fit:cover;border-radius:8px" />
    </div>
  </div>
</section>

<main class="main container">
  <div class="controls">
    <div class="filters" id="filters">
      <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
      <button class="filter-btn" data-filter="fruits">–§—Ä—É–∫—Ç—ã</button>
      <button class="filter-btn" data-filter="vegetables">–û–≤–æ—â–∏</button>
      <button class="filter-btn" data-filter="sets">–°–µ—Ç—ã</button>
      <button class="filter-btn" data-filter="promo">–ê–∫—Ü–∏–∏</button>
    </div>
    <div style="margin-left:auto" class="small">–ü–æ–∫–∞–∑–∞–Ω–æ <span id="shown-count">0</span> —Ç–æ–≤–∞—Ä–æ–≤</div>
  </div>

  <div style="margin-top:12px" class="fade-in">
    <div id="catalog" class="grid"></div>
  </div>
</main>

<!-- Cart Panel (–Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å) -->
<aside id="cart-panel" class="cart-panel" aria-hidden="true">
  <h4>–ö–æ—Ä–∑–∏–Ω–∞ <small style="color:var(--muted);font-weight:600">(<span id="cart-count-2">0</span>)</small></h4>
  <div class="cart-items" id="cart-items"></div>
  <div class="cart-total"><span>–ò—Ç–æ–≥–æ</span><span id="cart-sum">0 ‚ÇΩ</span></div>
  <div class="cart-actions">
    <button id="clear-cart" class="btn btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
    <button id="goto-checkout" class="btn btn-check">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </div>
</aside>

<!-- Floating Cart Widget -->
<div id="floating-cart" class="floating-cart" role="button" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É">
  <div style="display:flex;align-items:center;gap:10px">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M6 6h15l-1.5 9h-12z" stroke="#fff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="10" cy="20" r="1" fill="#fff"></circle><circle cx="18" cy="20" r="1" fill="#fff"></circle></svg>
  </div>
  <div class="fc-info">
    <div class="fc-count" id="fc-count">0 –ø–æ–∑.</div>
    <div class="fc-total" id="fc-total">0 ‚ÇΩ</div>
  </div>
</div>

<!-- Modal Checkout -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="panel">
    <h3 style="font-family:Poppins;margin:0 0 8px">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
    <div style="display:flex;gap:18px;flex-wrap:wrap">
      <div style="flex:1;min-width:280px">
        <div style="font-weight:700;margin-bottom:8px">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</div>
        <div id="modal-order-list" style="max-height:300px;overflow:auto;border:1px solid var(--border);padding:8px;border-radius:8px;background:#fff"></div>
        <div style="margin-top:10px;font-weight:800;display:flex;justify-content:space-between"><div>–ò—Ç–æ–≥–æ</div><div id="modal-total">0 ‚ÇΩ</div></div>
      </div>
      <div style="flex:1;min-width:280px">
        <form id="order-form">
          <div class="form-row"><label>–ò–º—è *</label><input id="cust-name" required></div>
          <div class="form-row"><label>–¢–µ–ª–µ—Ñ–æ–Ω *</label><input id="cust-phone" required></div>
          <div class="form-row"><label>–ì–æ—Ä–æ–¥ *</label><input id="cust-city" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞"></div>
          <div class="form-row"><label>–£–ª–∏—Ü–∞ *</label><input id="cust-street" required></div>
          <div class="form-row" style="display:flex;gap:8px"><div style="flex:1"><label>–î–æ–º *</label><input id="cust-house" required></div><div style="flex:1"><label>–ö–≤–∞—Ä—Ç–∏—Ä–∞</label><input id="cust-apartment"></div></div>
          <div class="form-row"><label>–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
            <select id="delivery-time"><option value="asap">–ö–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ</option><option value="custom">–£–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º—è</option></select>
            <input type="time" id="custom-time" style="display:none;margin-top:8px"></div>
          <div class="form-row"><label>–ü–æ—á—Ç–∞ –¥–ª—è —á–µ–∫–∞</label><input id="cust-email" type="email"></div>
          <div class="form-row"><label>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã *</label><select id="payment-method"><option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option><option value="card">–ö–∞—Ä—Ç–∞</option></select></div>
          <div class="form-actions" style="margin-top:12px">
            <button type="button" id="close-modal" class="btn btn-clear">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn btn-check">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<footer class="footer">¬© –§–µ—Ä–º–∞Fresh ‚Äî –°–≤–µ–∂–µ—Å—Ç—å, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å.</footer>

<script>
/* ========== –î–∞–Ω–Ω—ã–µ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞ ========== */
const products = [
  ["üçâ –ê—Ä–±—É–∑ ‚Äî 40‚ÇΩ/–∫–≥", "–ê—Ä–±—É–∑", 40, "fruits"],
  ["üçê –ì—Ä—É—à–∞ ‚Äî 340‚ÇΩ/–∫–≥", "–ì—Ä—É—à–∞", 340, "fruits"],
  ["üçä –ê–ø–µ–ª—å—Å–∏–Ω ‚Äî 220‚ÇΩ/–∫–≥", "–ê–ø–µ–ª—å—Å–∏–Ω", 220, "fruits"],
  ["üçà –î—ã–Ω—è —Ç–æ—Ä–ø–µ–¥–∞ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω ‚Äî 80‚ÇΩ/–∫–≥", "–î—ã–Ω—è —Ç–æ—Ä–ø–µ–¥–∞ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω", 80, "fruits"],
  ["üçà –î—ã–Ω—è –∫–æ–ª—Ö–æ–∑–Ω–∏—Ü–∞ ‚Äî 80‚ÇΩ/–∫–≥", "–î—ã–Ω—è –∫–æ–ª—Ö–æ–∑–Ω–∏—Ü–∞", 80, "fruits"],
  ["üçá –í–∏–Ω–æ–≥—Ä–∞–¥ –∑–µ–ª–µ–Ω—ã–π (–±–µ–∑ –∫–æ—Å—Ç–æ—á–µ–∫) ‚Äî 320‚ÇΩ/–∫–≥", "–í–∏–Ω–æ–≥—Ä–∞–¥ –∑–µ–ª–µ–Ω—ã–π (–±–µ–∑ –∫–æ—Å—Ç–æ—á–µ–∫)", 320, "fruits"],
  ["üçá –í–∏–Ω–æ–≥—Ä–∞–¥ —Ç–µ–º–Ω—ã–π (–±–µ–∑ –∫–æ—Å—Ç–æ—á–µ–∫) ‚Äî 320‚ÇΩ/–∫–≥", "–í–∏–Ω–æ–≥—Ä–∞–¥ —Ç–µ–º–Ω—ã–π (–±–µ–∑ –∫–æ—Å—Ç–æ—á–µ–∫)", 320, "fruits"],
  ["üçá –í–∏–Ω–æ–≥—Ä–∞–¥ —á–µ—Ä–Ω—ã–π (–ú–µ—Ä—Å–µ–¥–µ—Å) ‚Äî 300‚ÇΩ/–∫–≥", "–í–∏–Ω–æ–≥—Ä–∞–¥ —á–µ—Ä–Ω—ã–π (–ú–µ—Ä—Å–µ–¥–µ—Å)", 300, "fruits"],
  ["üçë –ù–µ–∫—Ç–∞—Ä–∏–Ω –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω –∫—Ä–∞—Å–Ω—ã–π ‚Äî 170‚ÇΩ/–∫–≥", "–ù–µ–∫—Ç–∞—Ä–∏–Ω –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω –∫—Ä–∞—Å–Ω—ã–π", 170, "fruits"],
  ["üçë –ù–µ–∫—Ç–∞—Ä–∏–Ω –¢—É—Ä—Ü–∏—è ‚Äî 350‚ÇΩ/–∫–≥", "–ù–µ–∫—Ç–∞—Ä–∏–Ω –¢—É—Ä—Ü–∏—è", 350, "fruits"],
  ["üçë –ù–µ–∫—Ç–∞—Ä–∏–Ω –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω –∂–µ–ª—Ç—ã–π (–≤–∫—É—Å –ª–∏–º–æ–Ω) ‚Äî 250‚ÇΩ/–∫–≥", "–ù–µ–∫—Ç–∞—Ä–∏–Ω –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω –∂–µ–ª—Ç—ã–π (–≤–∫—É—Å –ª–∏–º–æ–Ω)", 250, "fruits"],
  ["üçë –ù–µ–∫—Ç–∞—Ä–∏–Ω –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω –∑–µ–ª–µ–Ω—ã–π ‚Äî 190‚ÇΩ/–∫–≥", "–ù–µ–∫—Ç–∞—Ä–∏–Ω –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω –∑–µ–ª–µ–Ω—ã–π", 190, "fruits"],
  ["üçå –ë–∞–Ω–∞–Ω ‚Äî 170‚ÇΩ/–∫–≥", "–ë–∞–Ω–∞–Ω", 170, "fruits"],
  ["ü•î –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –ß—É–≤–∞—à–∏—è ‚Äî 45‚ÇΩ/–∫–≥", "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –ß—É–≤–∞—à–∏—è", 45, "vegetables"],
  ["ü•î –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä ‚Äî 45‚ÇΩ/–∫–≥", "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä", 45, "vegetables"],
  ["ü•ï –ú–æ—Ä–∫–æ–≤—å –í–æ–ª–≥–æ–≥—Ä–∞–¥ ‚Äî 45‚ÇΩ/–∫–≥", "–ú–æ—Ä–∫–æ–≤—å –í–æ–ª–≥–æ–≥—Ä–∞–¥", 45, "vegetables"],
  ["üßÖ –õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π –í–æ–ª–≥–æ–≥—Ä–∞–¥ ‚Äî 45‚ÇΩ/–∫–≥", "–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π –í–æ–ª–≥–æ–≥—Ä–∞–¥", 45, "vegetables"],
  ["üå± –õ—É–∫ –∑–µ–ª–µ–Ω—ã–π ‚Äî 350‚ÇΩ/–∫–≥", "–õ—É–∫ –∑–µ–ª–µ–Ω—ã–π", 350, "vegetables"],
  ["üå± –£–∫—Ä–æ–ø, –ø–µ—Ç—Ä—É—à–∫–∞ ‚Äî 350‚ÇΩ/–∫–≥", "–£–∫—Ä–æ–ø, –ø–µ—Ç—Ä—É—à–∫–∞", 350, "vegetables"],
  ["üå± –ö–∏–Ω–∑–∞ ‚Äî 440‚ÇΩ/–∫–≥", "–ö–∏–Ω–∑–∞", 440, "vegetables"],
  ["üå± –ë–∞–∑–µ–ª–∏–∫ ‚Äî 50‚ÇΩ/–ø—É—á–æ–∫", "–ë–∞–∑–µ–ª–∏–∫ (–ø—É—á–æ–∫)", 50, "vegetables"],
  ["üßÑ –ß–µ—Å–Ω–æ–∫ –¢–∞—à–∫–µ–Ω—Ç ‚Äî 400‚ÇΩ/–∫–≥", "–ß–µ—Å–Ω–æ–∫ –¢–∞—à–∫–µ–Ω—Ç", 400, "vegetables"],
  ["ü´ë –ü–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π ‚Äî 130‚ÇΩ/–∫–≥", "–ü–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π", 130, "vegetables"],
  ["üå∂Ô∏è –ü–µ—Ä–µ—Ü —á–∏–ª–∏ ‚Äî 25‚ÇΩ/—à—Ç", "–ü–µ—Ä–µ—Ü —á–∏–ª–∏", 25, "vegetables"],
  ["üçÖ –ü–æ–º–∏–¥–æ—Ä—ã –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω—Å–∫–∏–µ ‚Äî 220‚ÇΩ/–∫–≥", "–ü–æ–º–∏–¥–æ—Ä—ã –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω—Å–∫–∏–µ", 220, "vegetables"],
  ["üçÖ –ü–æ–º–∏–¥–æ—Ä—ã –†–æ—Å—Ç–æ–≤—Å–∫–∏–µ ‚Äî 180‚ÇΩ/–∫–≥", "–ü–æ–º–∏–¥–æ—Ä—ã –†–æ—Å—Ç–æ–≤—Å–∫–∏–µ", 180, "vegetables"],
  ["üçÖ –ü–æ–º–∏–¥–æ—Ä—ã –í–æ–ª–≥–æ–≥—Ä–∞–¥ (–º–µ–ª–∫–∏–µ) ‚Äî 80‚ÇΩ/–∫–≥", "–ü–æ–º–∏–¥–æ—Ä—ã –í–æ–ª–≥–æ–≥—Ä–∞–¥ (–º–µ–ª–∫–∏–µ)", 80, "vegetables"],
  ["üçÖ –ü–æ–º–∏–¥–æ—Ä—ã –¥–æ–º–∞—à–Ω–∏–µ ‚Äî 240‚ÇΩ/–∫–≥", "–ü–æ–º–∏–¥–æ—Ä—ã –¥–æ–º–∞—à–Ω–∏–µ", 240, "vegetables"],
  ["üçÖ –ü–æ–º–∏–¥–æ—Ä—ã –ê—Å—Ç—Ä–∞—Ö–∞–Ω—å (–∂–µ–ª—Ç—ã–µ) ‚Äî 190‚ÇΩ/–∫–≥", "–ü–æ–º–∏–¥–æ—Ä—ã –ê—Å—Ç—Ä–∞—Ö–∞–Ω—å (–∂–µ–ª—Ç—ã–µ)", 190, "vegetables"],
  ["ü•í –û–≥—É—Ä—Ü—ã –ú–æ—Å–∫–æ–≤—Å–∫–∏–µ ‚Äî 150‚ÇΩ/–∫–≥", "–û–≥—É—Ä—Ü—ã –ú–æ—Å–∫–æ–≤—Å–∫–∏–µ", 150, "vegetables"],
  ["ü•í –û–≥—É—Ä—Ü—ã –°–∞–º–∞—Ä—Å–∫–∏–µ ‚Äî 80‚ÇΩ/–∫–≥", "–û–≥—É—Ä—Ü—ã –°–∞–º–∞—Ä—Å–∫–∏–µ", 80, "vegetables"],
  ["ü•í –û–≥—É—Ä—Ü—ã –¥–æ–º–∞—à–Ω–∏–µ ‚Äî 150‚ÇΩ/–∫–≥", "–û–≥—É—Ä—Ü—ã –¥–æ–º–∞—à–Ω–∏–µ", 150, "vegetables"],
  ["üçë –°–ª–∏–≤–∞ 4 –≤–∏–¥–∞ ‚Äî 190‚ÇΩ/–∫–≥ - –¢–∞—à–∫–µ–Ω—Ç; –ú–µ–¥–æ–≤–∞—è - 220‚ÇΩ/–∫–≥; –ñ–µ–ª—Ç–∞—è - 250‚ÇΩ/–∫–≥; –ß–µ—Ä–Ω–æ—Å–ª–∏–≤–∞ - 220‚ÇΩ/–∫–≥", "–°–ª–∏–≤–∞ 4 –≤–∏–¥–∞", 220, "fruits"],
  ["üçí –ß–µ—Ä–µ—à–Ω—è ‚Äî 580‚ÇΩ/–∫–≥", "–ß–µ—Ä–µ—à–Ω—è", 580, "fruits"],
  ["ü´ê –ì–æ–ª—É–±–∏–∫–∞ ‚Äî 800‚ÇΩ/–∫–≥", "–ì–æ–ª—É–±–∏–∫–∞", 800, "fruits"],
  ["üçë –ê–±—Ä–∏–∫–æ—Å –ê—Ä–º–µ–Ω–∏—è ‚Äî 240‚ÇΩ/–∫–≥", "–ê–±—Ä–∏–∫–æ—Å –ê—Ä–º–µ–Ω–∏—è", 240, "fruits"],
  ["üçë –ê–±—Ä–∏–∫–æ—Å –ö–∏—Ä–≥–∏–∑–∏—è ‚Äî 150‚ÇΩ/–∫–≥", "–ê–±—Ä–∏–∫–æ—Å –ö–∏—Ä–≥–∏–∑–∏—è", 150, "fruits"],
  ["üçë –ü–µ—Ä—Å–∏–∫ –¢–∞—à–∫–µ–Ω—Ç ‚Äî 250‚ÇΩ/–∫–≥", "–ü–µ—Ä—Å–∏–∫ –¢–∞—à–∫–µ–Ω—Ç", 250, "fruits"],
  ["üçë –ü–µ—Ä—Å–∏–∫ –ê—Ä–º–µ–Ω–∏—è ‚Äî 380‚ÇΩ/–∫–≥", "–ü–µ—Ä—Å–∏–∫ –ê—Ä–º–µ–Ω–∏—è", 380, "fruits"],
  ["üçë –ü–µ—Ä—Å–∏–∫ –¢—É—Ä—Ü–∏—è ‚Äî 450‚ÇΩ/–∫–≥", "–ü–µ—Ä—Å–∏–∫ –¢—É—Ä—Ü–∏—è", 450, "fruits"],
  ["üçë –ü–µ—Ä—Å–∏–∫ –ò–Ω–∂–∏—Ä–Ω—ã–π ‚Äî 350‚ÇΩ/–∫–≥", "–ü–µ—Ä—Å–∏–∫ –ò–Ω–∂–∏—Ä–Ω—ã–π", 350, "fruits"],
  ["ü•ù –ö–∏–≤–∏ ‚Äî 450‚ÇΩ/–∫–≥", "–ö–∏–≤–∏", 450, "fruits"],
  ["–ö–∞–±–∞—á–æ–∫ ‚Äî 55‚ÇΩ/–∫–≥", "–ö–∞–±–∞—á–æ–∫", 55, "vegetables"],
  ["üçÜ –ë–∞–∫–ª–∞–∂–∞–Ω ‚Äî 130‚ÇΩ/–∫–≥", "–ë–∞–∫–ª–∞–∂–∞–Ω", 130, "vegetables"],
  ["üçã –õ–∏–º–æ–Ω ‚Äî 290‚ÇΩ/–∫–≥", "–õ–∏–º–æ–Ω", 290, "fruits"]
];

/* ========== State ========== */
let cart = []; // {id, name, price, qtyKg, total, components (optional)}
let visibleProducts = products.slice();
let currentFilter = 'all';

/* ========== DOM refs ========== */
const catalogEl = document.getElementById('catalog');
const shownCountEl = document.getElementById('shown-count');
const cartPanel = document.getElementById('cart-panel');
const cartItemsEl = document.getElementById('cart-items');
const cartSumEl = document.getElementById('cart-sum');
const fcCountEl = document.getElementById('fc-count');
const fcTotalEl = document.getElementById('fc-total');
const cartCountSmall = document.getElementById('cart-count-2');
const floatingCart = document.getElementById('floating-cart');
const gotoCheckoutBtn = document.getElementById('goto-checkout');
const clearCartBtn = document.getElementById('clear-cart');
const modal = document.getElementById('modal');
const modalOrderList = document.getElementById('modal-order-list');
const modalTotal = document.getElementById('modal-total');
const orderForm = document.getElementById('order-form');
const deliveryTimeSelect = document.getElementById('delivery-time');
const customTimeInput = document.getElementById('custom-time');
const heroOrderBtn = document.getElementById('hero-order');
const viewCatalogBtn = document.getElementById('view-catalog');
const searchInput = document.getElementById('search-input');
const sortSelect = document.getElementById('sort-select');
const loyaltyBadge = document.getElementById('loyalty-badge');

const allowedCities = ['–ú–æ—Å–∫–≤–∞','–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥','–ö–∞–∑–∞–Ω—å','–í–æ—Ä–æ–Ω–µ–∂','–°–∞–º–∞—Ä–∞']; // –ø—Ä–∏–º–µ—Ä –∑–æ–Ω –¥–æ—Å—Ç–∞–≤–∫–∏

/* ========== Helpers ========== */
function idify(s){ return s.replace(/\W+/g,'_'); }
function formatRub(v){ return Math.round(v) + ' ‚ÇΩ'; }
function displayQty(kg){ if(kg<1) return Math.round(kg*1000) + ' –≥'; return kg.toFixed(2) + ' –∫–≥'; }
function randInt(max){ return Math.floor(Math.random()*max); }

/* ========== Image loader (webp-first + fallbacks) ========== */
function tryLoadImage(imgEl, name){
  const exts = ['.webp','.jpg','.jpeg','.png','.gif'];
  const encoded = encodeURIComponent(name);
  const noimage = 'images/noimage.png';
  let idx = 0;

  function tryNext(){
    if(idx >= exts.length){
      imgEl.src = noimage;
      imgEl.onload = ()=> imgEl.style.opacity = '1';
      return;
    }
    const url = 'images/' + encoded + exts[idx];
    const tester = new Image();
    tester.onload = () => {
      imgEl.src = url;
      imgEl.onload = ()=> imgEl.style.opacity = '1';
    };
    tester.onerror = () => {
      idx++;
      tryNext();
    };
    tester.src = url;
  }
  tryNext();
}

/* ========== Render catalog with search/sort/recommendations ========== */
function renderCatalog(list){
  catalogEl.innerHTML = '';
  list.forEach((p, idxLocal) => {
    const [label,name,price,category] = p;
    // find global index in products array (best-effort)
    let globalIdx = products.findIndex(pp => pp[1] === name && pp[2] === price && pp[3] === category);
    if(globalIdx === -1) globalIdx = idxLocal; // fallback

    const card = document.createElement('div');
    card.className = 'card fade-in';

    card.innerHTML = `
      <div class="photo"><img alt="${name}" loading="lazy"></div>
      <div class="info">
        <div class="name">${label}</div>
        <div class="desc">${name}</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:auto">
          <div class="price">${price} ‚ÇΩ/–∫–≥</div>
          <div class="actions">
            <input class="qty-input" type="number" min="1" step="1" value="1" title="–ö–æ–ª-–≤–æ">
            <select class="unit-select" title="–ï–¥–∏–Ω–∏—Ü–∞">
              <option value="kg">–∫–≥</option>
              <option value="g">–≥—Ä</option>
            </select>
            <button class="add-to-cart" data-idx-global="${globalIdx}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>
        <div class="reco small" data-idx="${idxLocal}"></div>
      </div>
    `;
    catalogEl.appendChild(card);

    // load image with fallbacks
    const img = card.querySelector('img');
    tryLoadImage(img, name);

    // render recommendations (2 —Å–ª—É—á–∞–π–Ω—ã—Ö, –æ—Ç–ª–∏—á–Ω—ã—Ö –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ)
    const recoEl = card.querySelector('.reco');
    const others = products.map((pp,i)=> i !== globalIdx ? pp : null).filter(Boolean);
    const picks = [];
    while(picks.length < 2 && others.length){
      const k = randInt(others.length);
      picks.push(others.splice(k,1)[0]);
    }
    if(picks.length){
      recoEl.textContent = '–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º: ' + picks.map(x=>x[1]).join(', ');
    }
  });
  shownCountEl.textContent = list.length;
}

/* ========== Cart logic (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±—ã—á–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã) ========== */
function addToCart(productObj){
  // productObj: {name, price, qtyKg, components?}
  const existing = cart.find(i => i.name === productObj.name && JSON.stringify(i.components || []) === JSON.stringify(productObj.components || []));
  if(existing){
    existing.qtyKg += productObj.qtyKg;
    existing.total = existing.qtyKg * existing.price;
  } else {
    cart.push({
      id: idify(productObj.name) + '_' + Math.random().toString(36).slice(2,8),
      name: productObj.name,
      price: productObj.price,
      qtyKg: productObj.qtyKg,
      total: productObj.qtyKg * productObj.price,
      components: productObj.components || null
    });
  }
  console.log('analytics: add_to_cart', productObj);
  renderCart();
}

function removeFromCart(id){
  cart = cart.filter(i => i.id !== id);
  renderCart();
}

function clearCart(){
  cart = [];
  renderCart();
}

/* render cart panel */
function renderCart(){
  cartItemsEl.innerHTML = '';
  let sum = 0;
  cart.forEach(item => {
    sum += item.total;
    const row = document.createElement('div');
    row.className = 'cart-row';
    row.innerHTML = `
      <div class="left">
        <div style="font-weight:700">${item.name}${item.components ? ' (Custom)' : ''}</div>
        <div class="small" style="color:var(--muted)">${displayQty(item.qtyKg)} ‚Ä¢ ${formatRub(item.total)}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <button style="background:transparent;border:0;cursor:pointer;color:${'#e74c3c'}" data-remove="${item.id}">‚úï</button>
        <div style="font-weight:700">${formatRub(item.total)}</div>
      </div>
    `;
    cartItemsEl.appendChild(row);
  });
  cartSumEl.textContent = formatRub(sum);

  // count: number of positions (distinct items)
  const positionsCount = cart.length;
  // for floating widget display, show positions and total sum
  fcCountEl.textContent = positionsCount + ' –ø–æ–∑.';
  fcTotalEl.textContent = formatRub(sum);
  cartCountSmall.textContent = positionsCount;

  // attach remove handlers
  cartItemsEl.querySelectorAll('[data-remove]').forEach(btn => {
    btn.onclick = ()=> removeFromCart(btn.dataset.remove);
  });
}

/* ========== Delegation: add to cart from catalog ========== */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.add-to-cart');
  if(!btn) return;
  const idxGlobal = btn.dataset.idxGlobal !== undefined ? +btn.dataset.idxGlobal : null;
  const card = btn.closest('.card');
  const qtyInput = card.querySelector('.qty-input');
  const unitSelect = card.querySelector('.unit-select');
  const qty = parseFloat(qtyInput.value) || 0;
  const unit = unitSelect.value;
  let qtyKg = unit === 'g' ? qty/1000 : qty;
  if(qtyKg <= 0) return;

  // determine product source
  let product;
  if(idxGlobal !== null && products[idxGlobal]) {
    product = products[idxGlobal];
  } else {
    // fallback ‚Äî try to find by name text
    const name = card.querySelector('.desc')?.textContent?.trim();
    product = products.find(p => p[1] === name) || products[0];
  }
  const name = product[1];
  const price = product[2];
  addToCart({ name, price, qtyKg });

  // tiny check animation
  const ck = document.createElement('div'); ck.className = 'checkmark'; ck.textContent = '‚úì';
  const c = btn.closest('.card'); c.style.position = 'relative'; c.appendChild(ck);
  setTimeout(()=>{ ck.style.opacity = '1'; ck.style.transform = 'scale(1)'; }, 10);
  setTimeout(()=>{ ck.style.opacity = '0'; ck.style.transform = 'scale(.6)'; }, 900);
  setTimeout(()=>{ ck.remove(); }, 1200);
});

/* ========== Cart panel toggles via floating widget ========== */
let cartOpen = false;
floatingCart.addEventListener('click', ()=> {
  cartOpen = !cartOpen;
  if(cartOpen){
    cartPanel.classList.add('show');
    cartPanel.setAttribute('aria-hidden','false');
  } else {
    cartPanel.classList.remove('show');
    cartPanel.setAttribute('aria-hidden','true');
  }
});

/* hide panel when clicking outside (on small screens) */
document.addEventListener('click', (e) => {
  if(!cartPanel.classList.contains('show')) return;
  if(e.target.closest('.cart-panel') || e.target.closest('#floating-cart')) return;
  // clicked outside
  cartOpen = false;
  cartPanel.classList.remove('show');
  cartPanel.setAttribute('aria-hidden','true');
});

/* clear cart */
clearCartBtn.addEventListener('click', ()=> {
  clearCart();
  cartPanel.classList.remove('show');
  cartOpen = false;
});

/* filters (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏) */
document.getElementById('filters').addEventListener('click', (e) => {
  const b = e.target.closest('button[data-filter]');
  if(!b) return;
  document.querySelectorAll('#filters button').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const f = b.dataset.filter;
  currentFilter = f;
  if(f === 'all') visibleProducts = products.slice();
  else if(f === 'sets' || f === 'promo') visibleProducts = []; // none now
  else visibleProducts = products.filter(p => p[3] === f);
  applySearchAndSort();
});

/* search & sort */
searchInput.addEventListener('input', ()=> applySearchAndSort());
sortSelect.addEventListener('change', ()=> applySearchAndSort());

function applySearchAndSort(){
  const q = (searchInput.value || '').trim().toLowerCase();
  let list = (currentFilter === 'all') ? products.slice() : products.filter(p => p[3] === currentFilter);
  if(q) list = list.filter(p => (p[0] + ' ' + p[1]).toLowerCase().includes(q));
  const s = sortSelect.value;
  if(s === 'price_asc') list.sort((a,b)=> a[2] - b[2]);
  else if(s === 'price_desc') list.sort((a,b)=> b[2] - a[2]);
  else if(s === 'name_asc') list.sort((a,b)=> a[1].localeCompare(b[1],'ru'));
  else if(s === 'name_desc') list.sort((a,b)=> b[1].localeCompare(a[1],'ru'));
  visibleProducts = list;
  renderCatalog(visibleProducts);
}

/* ========== Checkout flow (modal) ========== */
gotoCheckoutBtn.addEventListener('click', ()=> {
  if(cart.length === 0){ alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã.'); return; }
  // populate modal order list
  modalOrderList.innerHTML = '';
  let sum = 0;
  cart.forEach(i => {
    const el = document.createElement('div');
    el.style.padding = '6px 4px';
    el.innerHTML = `<div style="font-weight:700">${i.name}${i.components ? ' (Custom)' : ''}</div><div style="color:var(--muted)">${displayQty(i.qtyKg)} ‚Ä¢ ${formatRub(i.total)}</div>`;
    modalOrderList.appendChild(el);
    sum += i.total;
  });
  modalTotal.textContent = formatRub(sum);
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden', 'false');
  console.log('analytics: open_checkout_modal');
});

document.getElementById('close-modal').addEventListener('click', ()=> {
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden', 'true');
});

/* delivery-time toggle */
deliveryTimeSelect.addEventListener('change', (e) => {
  customTimeInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
});

/* order submit */
orderForm.addEventListener('submit', (e) => {
  e.preventDefault();
  if(cart.length === 0){ alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!'); modal.style.display='none'; return; }
  const name = document.getElementById('cust-name').value.trim();
  const phone = document.getElementById('cust-phone').value.trim();
  const city = document.getElementById('cust-city').value.trim();
  const street = document.getElementById('cust-street').value.trim();
  const house = document.getElementById('cust-house').value.trim();
  const apt = document.getElementById('cust-apartment').value.trim();
  const time = deliveryTimeSelect.value === 'custom' ? (customTimeInput.value || '‚Äî') : '–ö–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ';
  const email = document.getElementById('cust-email').value.trim();
  const payment = document.getElementById('payment-method').value;

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–æ–Ω—ã –¥–æ—Å—Ç–∞–≤–∫–∏ (–ø—Ä–æ—Å—Ç–∞—è)
  if(!allowedCities.includes(city)){
    const ok = confirm(`–ü–æ—Ö–æ–∂–µ, –¥–æ—Å—Ç–∞–≤–∫–∞ –≤ –≥–æ—Ä–æ–¥ "${city}" –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ? (–ù–∞–∂–º–∏ –û—Ç–º–µ–Ω–∞, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –≥–æ—Ä–æ–¥.)`);
    if(!ok) return;
  }

  // build order text
  let message = 'üõí –í–∞—à –∑–∞–∫–∞–∑:\n\n';
  cart.forEach(i => {
    message += `${i.name} ‚Äî ${displayQty(i.qtyKg)} ‚Äî ${formatRub(i.total)}\n`;
    if(i.components && i.components.length){
      message += `  –°–æ—Å—Ç–∞–≤: ${i.components.map(c=>c.name).join(', ')}\n`;
    }
  });
  message += `\n–ò—Ç–æ–≥–æ: ${modalTotal.textContent}\n\n`;
  message += `üë§ –ò–º—è: ${name}\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\nüè† –ê–¥—Ä–µ—Å: ${city}, ${street}, –¥.${house}${apt ? ', –∫–≤. ' + apt : ''}\n‚è∞ –î–æ—Å—Ç–∞–≤–∫–∞: ${time}\n‚úâ –ü–æ—á—Ç–∞: ${email}\nüí≥ –û–ø–ª–∞—Ç–∞: ${payment}\n\n(–¢–µ—Å—Ç–æ–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ ‚Äî –∑–∞–∫–∞–∑ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä)`;

  alert(message);

  // –Ω–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã ‚Äî 5% –æ—Ç —Å—É–º–º—ã (–æ–∫—Ä—É–≥–ª—è–µ–º –≤–Ω–∏–∑)
  const sum = cart.reduce((s,i)=> s + i.total, 0);
  const points = Math.floor(sum * 0.05);
  addLoyaltyPoints(points);

  // –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—á–∏—Å—Ç–∫–∞
  console.log('analytics: order_submitted', {sum, points, items: cart});
  cart = [];
  renderCart();
  orderForm.reset();
  customTimeInput.style.display = 'none';
  modal.style.display = 'none';
});

/* hero / view catalog scroll */
heroOrderBtn.addEventListener('click', ()=> window.scrollTo({top: document.querySelector('.main').offsetTop - 20, behavior: 'smooth'}));
viewCatalogBtn.addEventListener('click', ()=> window.scrollTo({top: document.querySelector('.main').offsetTop - 20, behavior: 'smooth'}));

/* ========== Loyalty (localStorage) ========== */
function getLoyalty(){
  return parseInt(localStorage.getItem('ferma_loyalty') || '0', 10);
}
function setLoyalty(v){
  localStorage.setItem('ferma_loyalty', String(v));
  loyaltyBadge.textContent = '–ë–∞–ª–ª—ã: ' + v;
}
function addLoyaltyPoints(v){
  if(!v || v <= 0) return;
  const cur = getLoyalty();
  setLoyalty(cur + v);
  alert('–ù–∞—á–∏—Å–ª–µ–Ω–æ ' + v + ' –±–∞–ª–ª–æ–≤. –í—Å–µ–≥–æ: ' + (cur + v));
}

/* ========== Init ========== */
function init(){
  // load loyalty
  const l = getLoyalty();
  loyaltyBadge.textContent = '–ë–∞–ª–ª—ã: ' + l;

  // initial render
  visibleProducts = products.slice();
  renderCatalog(visibleProducts);
  renderCart();
}

init();
</script>
</body>
</html>
