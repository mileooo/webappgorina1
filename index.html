<script>
function renderCatalog(){
  catalogEl.innerHTML = '';
  let filtered = products.filter(p => p.category === selectedCategory);
  if(selectedSubcategory) filtered = filtered.filter(p=>p.subcategory===selectedSubcategory);

  filtered.forEach(prod=>{
    const id = idify(prod.name);
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML=`<div class="img-placeholder">Фото (пока)</div>
      <div class="title">${prod.name}</div>
      <div class="price muted">${prod.price} ₽/кг</div>`;
    
    const controls=document.createElement('div'); controls.className='controls';
    const qtyWrap=document.createElement('div'); qtyWrap.className='qty';
    const qtyInput=document.createElement('input'); qtyInput.type='number'; qtyInput.id=`qty-${id}`; qtyInput.step='0.1'; qtyInput.min='0.1'; qtyInput.value='1';
    const unitSelect=document.createElement('select'); unitSelect.className='unit-select'; unitSelect.id=`unit-${id}`;
    unitSelect.innerHTML=`<option value="kg">кг</option><option value="g">г</option>`;
    qtyWrap.appendChild(qtyInput); qtyWrap.appendChild(unitSelect);
    const addBtn = document.createElement('button'); addBtn.className='add-btn'; addBtn.textContent='Добавить';
    addBtn.onclick = ()=>{
      let qty = parseFloat(qtyInput.value);
      if(unitSelect.value==='g') qty/=1000; // граммы пересчет в кг
      addToCart(prod,qty);
    };
    controls.appendChild(qtyWrap); controls.appendChild(addBtn);
    card.appendChild(controls);
    catalogEl.appendChild(card);
  });
}

function addToCart(prod,qty){
  const existing = cart.find(c=>c.name===prod.name);
  if(existing){ existing.qty+=qty; existing.total=existing.qty*prod.price;}
  else cart.push({name:prod.name,qty,total:qty*prod.price});
  renderCart();
}

function renderCart(){
  cartListEl.innerHTML='';
  let total=0;
  cart.forEach(item=>{
    total+=item.total;
    const div=document.createElement('div'); div.className='cart-item';
    div.innerHTML=`<div class="left">${item.name} <span class="muted">${item.qty.toFixed(2)} кг</span></div>
      <div>${rub(item.total)}</div>
      <button class="remove" onclick="removeFromCart('${item.name}')">×</button>`;
    cartListEl.appendChild(div);
  });
  cartTotalEl.textContent = 'Итого: '+rub(total);
}

function removeFromCart(name){
  cart = cart.filter(c=>c.name!==name);
  renderCart();
}

clearBtn.onclick = ()=>{
  cart=[];
  renderCart();
}

checkoutBtn.onclick = ()=>{
  alert('Тестовый заказ:\n'+cart.map(c=>c.name+' — '+c.qty.toFixed(2)+' кг — '+rub(c.total)).join('\n'));
}

categoryButtons.querySelectorAll('button').forEach(btn=>{
  btn.onclick=()=>{
    categoryButtons.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    selectedCategory = btn.dataset.cat;
    selectedSubcategory=null;
    renderSubcategories();
    renderCatalog();
  }
});

renderSubcategories();
renderCatalog();
</script>
